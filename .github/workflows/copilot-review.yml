name: Copilot AI - Code Review

on:
  pull_request:
    types: [opened, synchronize]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  copilot-code-review:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get PR files
        id: files
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              per_page: 100
            });
            
            const relevantFiles = files
              .filter(f => !f.filename.includes('node_modules') && 
                          !f.filename.includes('.next') &&
                          !f.filename.includes('dist'))
              .slice(0, 20); // Limita a 20 file
            
            console.log(`ðŸ“ Found ${relevantFiles.length} files to review`);
            
            return relevantFiles.map(f => ({
              filename: f.filename,
              status: f.status,
              additions: f.additions,
              deletions: f.deletions,
              patch: f.patch
            }));

      - name: Review with GitHub Copilot
        id: review
        uses: actions/github-script@v7
        env:
          COPILOT_TOKEN: ${{ secrets.COPILOT_TOKEN }}
        with:
          script: |
            const files = ${{ steps.files.outputs.result }};
            const token = process.env.COPILOT_TOKEN;
            
            console.log(`ðŸ” Reviewing ${files.length} files with Copilot...`);
            
            // Prepara context per Copilot
            const filesContext = files.map(f => `
            File: ${f.filename}
            Status: ${f.status}
            Changes: +${f.additions} -${f.deletions}
            
            \`\`\`diff
            ${f.patch ? f.patch.substring(0, 500) : 'No patch available'}
            \`\`\`
            `).join('\n---\n');
            
            // Chiamata API GitHub Copilot
            const response = await fetch('https://api.github.com/copilot/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'Editor-Version': 'vscode/1.85.0'
              },
              body: JSON.stringify({
                messages: [
                  {
                    role: 'system',
                    content: `Sei un senior code reviewer. Analizza il codice per:
            - ðŸ”’ Security vulnerabilities
            - âš¡ Performance issues
            - ðŸ§¹ Code quality & best practices
            - ðŸ§ª Testing coverage
            - ðŸ“š Documentation
            
            Fornisci feedback costruttivo e specifico.`
                  },
                  {
                    role: 'user',
                    content: `Review questa Pull Request:\n\n${filesContext}\n\nFornisci:\n1. Summary complessivo\n2. Issues critici (se presenti)\n3. Suggerimenti miglioramento\n4. Rating (1-5)`
                  }
                ],
                model: 'gpt-4',
                temperature: 0.3,
                max_tokens: 1500
              })
            });
            
            const data = await response.json();
            
            if (!data.choices || data.choices.length === 0) {
              throw new Error(`Copilot API error: ${JSON.stringify(data)}`);
            }
            
            const review = data.choices[0].message.content;
            
            console.log('=== COPILOT REVIEW ===');
            console.log(review);
            
            return {
              files_count: files.length,
              review,
              status: 'completed'
            };

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const reviewData = ${{ steps.review.outputs.result }};
            
            const body = `## ðŸ¤– GitHub Copilot Code Review
            
            **Files analyzed:** ${reviewData.files_count}
            **Status:** âœ… Review completed
            
            ---
            
            ${reviewData.review}
            
            ---
            
            ### Pre-merge Checklist
            
            - [ ] All tests passing
            - [ ] No security issues
            - [ ] Code follows project standards
            - [ ] Documentation updated
            - [ ] No breaking changes (or documented)
            
            *Generated by GitHub Copilot AI Agent*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Add labels
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['copilot-reviewed', 'automated']
            });
