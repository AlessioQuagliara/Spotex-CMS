name: Copilot AI - Feature Generator

on:
  workflow_dispatch:
    inputs:
      instruction_file:
        description: 'Instruction file (e.g., 02-products-crud.md)'
        required: true
        type: string
      create_files:
        description: 'Create actual files (not just analysis)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  copilot-generate-feature:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Load instruction
        id: instruction
        run: |
          INSTRUCTION_FILE="${{ github.event.inputs.instruction_file }}"
          FULL_PATH=".github/agents/instructions/$INSTRUCTION_FILE"
          
          if [ ! -f "$FULL_PATH" ]; then
            echo "‚ùå Instruction file not found: $FULL_PATH"
            exit 1
          fi
          
          INSTRUCTION=$(cat "$FULL_PATH")
          FEATURE_NAME=$(basename "$INSTRUCTION_FILE" .md)
          
          echo "instruction_file=$FULL_PATH" >> $GITHUB_OUTPUT
          echo "feature_name=$FEATURE_NAME" >> $GITHUB_OUTPUT
          
          # Salva istruzione (multiline safe)
          echo "INSTRUCTION<<EOF" >> $GITHUB_ENV
          echo "$INSTRUCTION" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Load templates
        id: templates
        run: |
          echo "COMPONENT_TEMPLATE<<EOF" >> $GITHUB_ENV
          cat .github/agents/templates/component.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "API_TEMPLATE<<EOF" >> $GITHUB_ENV
          cat .github/agents/templates/api-endpoint.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "PAGE_TEMPLATE<<EOF" >> $GITHUB_ENV
          cat .github/agents/templates/page.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Generate code with GitHub Copilot
        id: copilot
        uses: actions/github-script@v7
        env:
          COPILOT_TOKEN: ${{ secrets.COPILOT_TOKEN }}
        with:
          script: |
            const instruction = process.env.INSTRUCTION;
            const componentTemplate = process.env.COMPONENT_TEMPLATE;
            const apiTemplate = process.env.API_TEMPLATE;
            const pageTemplate = process.env.PAGE_TEMPLATE;
            const token = process.env.COPILOT_TOKEN;
            const featureName = '${{ steps.instruction.outputs.feature_name }}';
            
            console.log(`üöÄ Generating code for: ${featureName}`);
            
            // Chiamata API GitHub Copilot per generazione codice
            const response = await fetch('https://api.github.com/copilot/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'Editor-Version': 'vscode/1.85.0'
              },
              body: JSON.stringify({
                messages: [
                  {
                    role: 'system',
                    content: `Sei un expert full-stack developer specializzato in FastAPI (backend) e Next.js/React (frontend).
            
            TEMPLATES DISPONIBILI:
            - Component: React/TypeScript con shadcn/ui
            - API: FastAPI con SQLAlchemy e Pydantic
            - Page: Next.js App Router
            
            Genera codice production-ready seguendo questi template.`
                  },
                  {
                    role: 'user',
                    content: `Implementa questa feature completa:\n\n${instruction}\n\n---\n\nREFERENCE TEMPLATES:\n\n## Component Template\n${componentTemplate.substring(0, 1000)}\n\n## API Template\n${apiTemplate.substring(0, 1000)}\n\n## Page Template\n${pageTemplate.substring(0, 1000)}\n\n---\n\nGenera:\n1. Backend (FastAPI + SQLAlchemy + Pydantic schemas)\n2. Frontend (React components + pages + hooks)\n3. Tests (pytest + jest)\n\nFormato output:\n\`\`\`python\n# backend/app/models/...py\n...\n\`\`\`\n\n\`\`\`typescript\n// frontend/admin/app/...tsx\n...\n\`\`\``
                  }
                ],
                model: 'gpt-4',
                temperature: 0.2,
                max_tokens: 4000
              })
            });
            
            const data = await response.json();
            
            if (!data.choices || data.choices.length === 0) {
              throw new Error(`Copilot API error: ${JSON.stringify(data)}`);
            }
            
            const generatedCode = data.choices[0].message.content;
            
            console.log('=== GENERATED CODE ===');
            console.log(generatedCode);
            
            // Salva codice generato
            const fs = require('fs');
            const outputFile = `generated-${featureName}.md`;
            fs.writeFileSync(outputFile, `# Feature: ${featureName}\n\nGenerated: ${new Date().toISOString()}\n\n---\n\n${generatedCode}`);
            
            core.setOutput('code', generatedCode);
            core.setOutput('output_file', outputFile);
            
            return { 
              feature: featureName, 
              lines: generatedCode.split('\n').length,
              status: 'completed'
            };

      - name: Create files (if enabled)
        if: github.event.inputs.create_files == 'true'
        run: |
          echo "‚ö†Ô∏è  File creation not implemented yet"
          echo "Generated code is in: ${{ steps.copilot.outputs.output_file }}"
          echo "Review the generated code manually and create files as needed"

      - name: Create PR
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'feat: ${{ steps.instruction.outputs.feature_name }} (generated by Copilot)'
          title: '‚ú® Feature: ${{ steps.instruction.outputs.feature_name }}'
          body: |
            ## ü§ñ GitHub Copilot Feature Generation
            
            **Feature:** ${{ steps.instruction.outputs.feature_name }}
            **Instruction:** ${{ steps.instruction.outputs.instruction_file }}
            **Generated Lines:** ${{ steps.copilot.outputs.lines }}
            
            ### üìù Generated Code
            
            See `${{ steps.copilot.outputs.output_file }}` for the complete generated code.
            
            ${{ steps.copilot.outputs.code }}
            
            ### ‚ö†Ô∏è Review Checklist
            
            - [ ] Review all generated code
            - [ ] Create actual files from generated code
            - [ ] Add tests
            - [ ] Test locally
            - [ ] Update documentation
            
            ---
            *Generated by GitHub Copilot AI Agent*
          branch: copilot/feature-${{ steps.instruction.outputs.feature_name }}
          delete-branch: false
          labels: 'copilot-ai,feature,needs-review'
