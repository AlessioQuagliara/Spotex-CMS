name: Copilot AI - Daily Analysis

on:
  schedule:
    - cron: '0 9 * * *'  # 09:00 UTC daily
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  copilot-daily-tasks:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Load instruction
        id: instruction
        run: |
          TASK_FILE=".github/agents/instructions/01-ui-theme-fix.md"
          INSTRUCTION=$(cat "$TASK_FILE")
          echo "task_file=$TASK_FILE" >> $GITHUB_OUTPUT
          # Salva per step successivo (multiline safe)
          echo "INSTRUCTION<<EOF" >> $GITHUB_ENV
          echo "$INSTRUCTION" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Analyze with GitHub Copilot
        id: copilot
        uses: actions/github-script@v7
        env:
          COPILOT_TOKEN: ${{ secrets.COPILOT_TOKEN }}
        with:
          script: |
            const instruction = process.env.INSTRUCTION;
            const token = process.env.COPILOT_TOKEN;
            
            // Chiamata API GitHub Copilot
            const response = await fetch('https://api.github.com/copilot/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'Editor-Version': 'vscode/1.85.0'
              },
              body: JSON.stringify({
                messages: [
                  {
                    role: 'system',
                    content: 'Sei un AI agent che analizza task di sviluppo e verifica implementazioni.'
                  },
                  {
                    role: 'user',
                    content: `Analizza questa istruzione e verifica se l'implementazione Ã¨ completa:\n\n${instruction}\n\nVerifica ogni elemento della checklist e genera un report dettagliato.`
                  }
                ],
                model: 'gpt-4',
                temperature: 0.3,
                max_tokens: 2000
              })
            });
            
            const data = await response.json();
            const analysis = data.choices[0].message.content;
            
            console.log('=== COPILOT ANALYSIS ===');
            console.log(analysis);
            
            // Salva analisi
            const fs = require('fs');
            fs.writeFileSync('copilot-daily-analysis.md', `# Daily Analysis - ${new Date().toISOString()}\n\n${analysis}`);
            
            core.setOutput('analysis', analysis);
            return { status: 'completed', analysis };

      - name: Create PR with results
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore(copilot): daily analysis results'
          title: 'ðŸ¤– Copilot Daily Analysis - ${{ github.run_number }}'
          body: |
            ## ðŸ¤– GitHub Copilot Daily Analysis
            
            **Run:** ${{ github.run_number }}
            **Date:** ${{ github.event.schedule || 'Manual trigger' }}
            
            ### Analysis Results
            
            ${{ steps.copilot.outputs.analysis }}
            
            ---
            *This PR was automatically generated by GitHub Copilot AI Agent*
          branch: copilot/daily-${{ github.run_number }}
          delete-branch: true
          labels: 'copilot-ai,automated,daily-analysis'
