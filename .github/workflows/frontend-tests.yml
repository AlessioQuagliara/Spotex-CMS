name: Frontend Tests

on:
  push:
    branches: [main, develop]
    paths:
      - "frontend/**"
  pull_request:
    branches: [main, develop]
    paths:
      - "frontend/**"

jobs:
  test-admin:
    name: Test Admin Frontend
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend/admin
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/admin/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Run type check
        run: npx tsc --noEmit
      
      - name: Run unit tests
        run: npm run test:unit -- --ci --coverage --maxWorkers=2
      
      - name: Run integration tests
        run: npm run test:integration -- --ci --maxWorkers=2
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./frontend/admin/coverage/lcov.info
          flags: admin
          name: admin-coverage
      
      - name: Run E2E tests
        run: npm run e2e:headless
        env:
          CYPRESS_BASE_URL: http://localhost:3001
      
      - name: Upload Cypress screenshots
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: cypress-screenshots
          path: frontend/admin/cypress/screenshots
      
      - name: Upload Cypress videos
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cypress-videos
          path: frontend/admin/cypress/videos
  
  test-render:
    name: Test Render Frontend
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./frontend/render
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: frontend/render/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Run type check
        run: npx tsc --noEmit
      
      - name: Build project
        run: npm run build
      
      - name: Check bundle size
        run: |
          BUNDLE_SIZE=$(du -sb .next/static | cut -f1)
          BUNDLE_SIZE_KB=$((BUNDLE_SIZE / 1024))
          echo "Bundle size: ${BUNDLE_SIZE_KB}KB"
          if [ $BUNDLE_SIZE_KB -gt 1024 ]; then
            echo "⚠️ Bundle size exceeds 1MB"
            exit 1
          fi
  
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    needs: [test-admin, test-render]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
      
      - name: Install dependencies
        working-directory: ./frontend/admin
        run: npm ci
      
      - name: Build project
        working-directory: ./frontend/admin
        run: npm run build
      
      - name: Start server
        working-directory: ./frontend/admin
        run: |
          npm run start &
          npx wait-on http://localhost:3000
      
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: |
            http://localhost:3000
            http://localhost:3000/dashboard
            http://localhost:3000/products
          uploadArtifacts: true
          temporaryPublicStorage: true
          budgetPath: ./lighthouse-budget.json
